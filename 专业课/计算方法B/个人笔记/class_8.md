# 数值微分和积分
---
## 数值微分
### 前向差分公式/后向差分公式
* 基本思想：最朴素的想法\[f'(x_0)=\frac{f(x_0+h)-f(x_0)}{h} \]如果用拉格朗日一阶插值多项式给出精确解释，得到\[f(x)=\frac{x-x_0}{h}f(x_0+h)+\frac{x-x_0-h}{-h}f(x_0)+\frac{1}{2}(x-x_0)(x-x_0-h)f''(\xi) \]因此\[f'(x_0)=\frac{f(x_0+h)-f(x_0)}{h}-\frac{h}{2}f''(\xi) \]我们预期得到 $O(h)$ 的误差。<br/><br/> 

* 前向差分公式：\[f'(x)=\frac{f(x+h)-f(x)}{h} \]当 $h<0$ 时称为后向差分公式。
 
### (n+1)-point formula
* 基本想法：自然会想到用更高阶的拉格朗日插值多项式来提高精度。当我们有 $x_0,x_1,\ldots,x_n$ 时，可以类似地得到\[f'(x_j)=\sum_{k=0}^n f(x_k)L_k'(x_j)+\frac{f^{(n+1)(\xi(x_j))} }{(n+1)!}\prod_{k=0;k\ne j}^{n}(x-x_k) \]

* 当插值多项式的结束提高时，精度一般会更好，但是由于舍入误差，一般常用的有三点和五点的公式。<br/><br/>

* 三点公式：取 $x_0 = x_0,\;x_1=x_0+h,\;x_2=x_0+2h$ ，则\[f'(x_0)=\frac{1}{h}(-\frac{3}{2}f(x_0)+2f(x_1)-\frac{1}{2}f(x_2))+\frac{h^2}{3}f^{(3)}(\xi_0) \]\[f'(x_1)=\frac{1}{h}(-\frac{1}{2}f(x_0)+\frac{1}{2}f(x_2))-\frac{h^2}{6}f^{(3)}(\xi_1) \]\[f'(x_2)=\frac{1}{h}(\frac{3}{2}f(x_0)-2f(x_1)+\frac{1}{2}f(x_2))+\frac{h^2}{3}f^{(3)}(\xi_0) \]或者将自变量都换为 $x_0$ 得到\[f'(x_0)=\frac{1}{2h}(-3f(x_0)+4f(x_0+h)-f(x_0+2h))+\frac{h^2}{3}f^{(3)}(\xi_0) \]\[f'(x_0)=\frac{1}{2h}(-f(x_0-h)+f(x_0+h))-\frac{h^2}{6}f^{(3)}(\xi_1) \]前者称为三点端点公式，后者称为三点中点公式。<br/><br/>

### 二阶导数中点公式
* 基本思想：用泰勒多项式展开计算二阶导数。
* 基本过程：由泰勒展开公式：\[f(x_0+h)=f(x_0)+f'(x_0)h+\frac{1}{2}f''(x_0)h^2 +\frac{1}{6}f'''(x_0)h^3+\frac{1}{24}f''''(\xi_1)h^4 \]\[f(x_0-h)=f(x_0)-f'(x_0)h+\frac{1}{2}f''(x_0)h^2 -\frac{1}{6}f'''(x_0)h^3+\frac{1}{24}f''''(\xi_{-1})h^4 \]两式相加得到\[f''(x_0)=\frac{1}{h^2}(f(x_0-h)-2f(x_0)+f(x_0+h))-\frac{h^2}{24}(f^{(4)}(\xi_1)+f^{(4)}(\xi_{-1} )) \]

### 外推法
* 只要误差项有形式\[k_1h+k_2h^2+k_3h^3+\cdots\]其中 $k_i$ 与 $h$ 无关，都可以考虑用外推法来提高精度。当用泰勒公式进行估计时，刚好得到与步长无关的系数。

## 数值积分
* 基本思想：用插值多项式近似表示原函数后，对插值多项式进行积分。如果用拉格朗日多项式，则积分式可以表达成：\[\int_a^b f(x)dx=\int_a^b \sum_{i=0}^nf(x_i)L_i(x)dx+\int_a^b\frac{f^{(n+1)}(\xi(x)) }{(n+1)!}dx=\newline \sum_{i=0}^na_if(x_i)+\frac{1}{(n+1)!}\int_a^b\prod_{i=0}^n(x-x_i)f^{(n+1)}(\xi(x))dx \]

### 梯形公式
* 基本思想：取点 $x_0=a,\;x_1=b$ ，构造拉格朗日插值多项式：\[P_1(x)=\frac{(x-x_1)}{(x_0-x_1)}f(x_0)+\frac{(x-x_0)}{(x_1-x_0)}f(x_1)+\frac{1}{2}f''(\xi)(x-x_0)(x-x_1) \]于是积分结果为\[\int_a^bf(x)dx=\frac{(x_1-x_0)}{2}[f(x_0)+f(x_1) ]-\frac{h^3}{12}f''(\xi) \]

### Simpson 公式
* 基本思想：取点 $x_0 = a,\;x_1 = a+h,\;x_2=b$ 其中 $h=(b-a)/2$ ，构造拉格朗日插值多项式，\[P_2 = \frac{(x-x_1)(x-x_2)}{(x_0-x_1)(x_0-x_2)}f(x_0)+\frac{(x-x_0)(x-x_2)}{(x_1-x_0)(x_1-x_2)}f(x_1)+\frac{(x-x_0)(x-x_1)}{(x_2-x_0)(x_2-x_0)}f(x_2)\newline +\frac{1}{6}f'''(\xi)(x-x_0)(x-x_1)(x-x_2) \]但这时我们只能得到 $O(h^4) $ 的误差界限，如果采用泰勒公式，可以得到 $O(h^5)$ 的误差限。事实上，在 $x_1$ 处将函数 $f(x)$ 展开 \[f(x)=f(x_1)+f'(x_1)(x-x_1)+\frac{f''(x_1)}{2}(x-x_1)^2+\frac{f'''(x_1)}{6}(x-x_1)^3+\frac{f^{(4)}(\xi(x)) }{24}(x-x_1)^4 \] 此时积分得\[\int_{x_0}^{x_2}f(x)dx=2hf(x_1)+\frac{h^3}{3}f''(x_1)+\frac{f^{(4)}(\xi_1) }{60}h^5 \] 如果带入二阶导数中点公式\[f''(x)=\frac{1}{h^2}(f(x-h)-2f(x)+f(x+h)) \]则有\[\int_{x_0}^{x_2}f(x)dx=\frac{h}{3}(f(x_0)+4f(x_1)+f(x_2))-\frac{h^5}{90}f^{(4)}(\xi) \]

### 准确度
* 定义：积分表达式能精确求积的多项式的最大阶数。精确度为 n 意味着该积分表达式对于 0 到 n 阶的多项式都可以精确求积，但是对 n+1 阶的多项式会产生误差。<br/><br/>

* 例如梯形公式的精确度是 1 ，Simpson 公式的精确度是 3 。

### Closed Newton-Cotes Formula
* 定义：将区间端点作为插值点的公式。例如梯形公式和 Simpson 公式都属于这一类。<br/><br/>

* 误差分析：对于 n+1 个插值点 $x_0=a,\;x_n=b,\;h=(b-a)/n $ 如果 n 是偶数，则 \[\int_a^bf(x)dx=\sum_{i=0}^na_if(x_i)+\frac{h^{n+3}f^{(n+2)}(\xi) }{(n+2)!}\int_0^nt^2(t-1)\cdots(t-n)dt \]如果 n 是奇数，则\[\int_a^bf(x)dx=\sum_{i=0}^na_if(x_i)+\frac{h^{n+2}f^{(n+1)}(\xi) }{(n+1)!}\int_0^nt^(t-1)\cdots(t-n)dt \]因此如果 n 是偶数，则准确度是 n+1 ，如果 n 是奇数，那么准确度是 n。<br/><br/>

* 例子：
    * n=1 :（梯形公式）\[\int_{x_0}^{x_1}f(x)dx=\frac{h}{2}[f(x_0)+f(x_1) ]-\frac{h^3}{12}f''(\xi) \]
    * n=2 : （Simpson 公式）\[\int_{x_0}^{x_2}f(x)dx=\frac{h}{3}(f(x_0)+4f(x_1)+f(x_2))-\frac{h^5}{90}f^{(4)}(\xi) \]

### Open Newton-Cotes Formula
* 定义：不将区间端点作为插值点的公式。<br/><br/>

* 误差分析：对于 n+1 个插值点 $x_{-1}=a,\;x_{n+1}=b,\;h=(b-a)/{n+2} $ 如果 n 是偶数，则 \[\int_a^bf(x)dx=\sum_{i=0}^na_if(x_i)+\frac{h^{n+3}f^{(n+2)}(\xi) }{(n+2)!}\int_0^nt^2(t-1)\cdots(t-n)dt \]如果 n 是奇数，则\[\int_a^bf(x)dx=\sum_{i=0}^na_if(x_i)+\frac{h^{n+2}f^{(n+1)}(\xi) }{(n+1)!}\int_0^nt^(t-1)\cdots(t-n)dt \]因此如果 n 是偶数，则准确度是 n+1 ，如果 n 是奇数，那么准确度是 n。<br/><br/>

* 例子：
    * n=0 ：\[\int_{x_{-1} }^{x_1}f(x)dx=2hf(x_0)+\frac{h^2}{3}f''(\xi) \]
    * n=1 ：\[\int_{x_{-1} }^{x_2}f(x)dx=\frac{3h}{2} (f(x_0)+f(x_1))+\frac{3h^3}{4}f''(\xi) \]
    * n=2 ：\[\int_{x_{-1} }^{x_3}f(x)dx=\frac{4h}{3} (2f(x_0)-f(x_1)+2f(x_2))+\frac{14h^5}{45}f^{(4)}(\xi) \]

### 组合 Simpson 公式
* 基本思想：考虑将整个区间分为几个小区间，在每个区间上分别求得积分后再求和。这样可以将原来不变的步长 $h=(b-a)/2$ 缩小为 $h=(b-a)/n $ ，其中 $n $ 是分成的小区间数，为偶数（为了满足在每两个相邻的区间上运用 Simpson 公式的要求）。步长的减小能使误差显著减小。<br/><br/>

* 基本过程：令 $h=(b-a)/n,\;\;x_j = a+jh,\;j=0,1,\ldots,n $ 则\[\int_a^bf(x)dx=\sum_{j=1}^{n/2}\int_{x_{2j-2} }^{x_{2j} }f(x)dx\newline = \sum_{j=1}^{n/2}(\frac{h}{3}(f(x_{2j-2})+4f(x_{2j-1})+f(x_{2j})-\frac{h^5}{90}f^{(4)}(\xi_j)))\newline =\frac{h}{3}(f(x_0)+2\sum_{j=1}^{(n/2)-1}f(x_{2j})+4\sum_{j=1}^{n/2}f(x_{2j-1})+f(x_n))-\frac{h^5}{90}\frac{n}{2}f^{(4)}(\mu)\newline = \frac{h}{3}(f(a)+2\sum_{j=1}^{(n/2)-1}f(x_{2j})+4\sum_{j=1}^{n/2}f(x_{2j-1})+f(b))-\frac{(b-a)}{180}h^4f^{(4)}(\mu) \]

### 组合梯形公式
* 设 $n=(b-a)/n,\;\;x_j=a+jh,\;j=0,1,\ldots,n$ ，则有
\[\int_a^bf(x)dx=\frac{h}{2}(f(a)+2\sum_{j=1}^{n-1}f(x_j)+f(b) )-\frac{b-a}{12}h^2f''(\mu) \]

### 组合中点公式
* 设 $h=(b-a)/(n+2),\;\; x_j=a+(j+1)h,\;j=-1,0,\ldots,n+1 $ ，则有
\[\int_a^bf(x)dx = 2h\sum_{j=0}^{n/2}f(x_{2j})+\frac{b-a}{6}h^2f''(\mu) \]

### Romberg 积分公式
* 基本思想：对于组合梯形公式，可以证明其误差项具有形式\[k_1h^2+k_2h^4+\cdots \] 因此可以考虑使用外推法来提高精度。<br/><br/>

* 基本过程：组合梯形公式\[\int_a^bf(x)dx=\frac{h}{2}(f(a)+2\sum_{j=1}^{n-1}f(x_j)+f(b) )\] 首先计算不用外推法时在 n 取不同值时的结果，记为 $R_{k,1}$ 。在这步中可以利用公式形式上的重复性减少函数值的计算，具体表示为 \[R_{k,1}=\frac{1}{2}(R{k-1,1}+h_{k-1}\sum_{i=1}^{2^{k-2} }f(a+(2i-1)h_k)) \]然后利用标准的外推法：\[R_{k,2}=R_{k,1}+\frac{1}{3}(R_{k,1}-R_{k-1,1}),\;k=2,3,\ldots \]\[R_{k,3}=R_{k,2}+\frac{1}{15}(R_{k,2}-R_{k-1,2}),\;k=3,4,\ldots \]\[R_{k,j}=R_{k,j-1}+\frac{1}{4^{j-1}-1 }(R_{k,j-1}-R_{k-1,j-1}),\;k=j,j+1,\ldots \]当对角线上最后两个值的差值在允许范围内时即可结束。

### Adaptive quadrature method
* 基本思想：在组合积分公式中，积分精度容易受到等区间长度取点的影响。考虑在不同区间上使用不同的步长来消除这种弊端。<br/><br/>

* 基本过程：以组合 Simpson 公式为例，设积分区间为 $[a,b]$ 。如果采用 $n=2$ 情形下的 Simpson 公式，则结果为\[\int_a^bf(x)dx=\frac{h}{3}(f(a)+4f(a+h)+f(b))-\frac{h^5}{90}f^{(4)}(\xi) \]其中 $h=(b-a)/2 $ 。将该公式简记为\[\int_a^bf(x)dx=S(a,b)-\frac{h^5}{90}f^{(4)}(\xi) \]再采用 $n=4$ 情况下的 Simpson 公式，$h$ 仍然定义为 $h=(b-a)/2 $ ：\[\int_a^bf(x)dx=\frac{h}{6}(f(a)+4f(a+h/2)+f(a+h) )\newline + \frac{h}{6}(f(a+h)+4f(a+3h/2)+f(b) )\newline -(\frac{h}{2})^4\frac{(b-a)}{180}f^{(4)}(\tilde{\xi}) \]该公式简记成：\[\int_a^bf(x)dx=S(a,(a+b)/2)+S((a+b)/2,b)-\frac{1}{16}(\frac{h^5}{90})f^{(4)}(\tilde{\xi}) \]如果忽略 $\xi$ 和 $\tilde{\xi}$ 之间的差别，那么\[S(a,b)-\frac{h^5}{90}f^{(4)}(\xi)\approx S(a,(a+b)/2)+S((a+b)/2,b)-\frac{1}{16}(\frac{h^5}{90})f^{(4)}(\xi) \]从中解出 $f^{(4)}(\xi) $ 后重新带入 $n=4$ 时的公式得 \[|\int_a^bf(x)dx-S(a,\frac{a+b}{2})-S(\frac{a+b}{2},b) |\approx \frac{1}{16}(\frac{h^5}{90})f^{(4)}(\xi)\newline\approx\frac{1}{15}|S(a,b)-S(a,\frac{a+b}{2})-S(\frac{a+b}{2},b) | \]因此如果有右端小于 $15\epsilon$ 则有左端小于 $\epsilon$ 。由此来估计误差。如果在误差允许范围内，则估计成功。否则分别在左右两半继续细分求误差，看是否能小于 $\epsilon /2$ ，由此不断递归，直到精度达到要求。

### Gaussian Quadrature
* 基本思想：在 Closed Newton-Cotes formula 中，我们利用 $n$ 阶拉格朗日插值多项式得到的积分表达式的误差项含有 $n+1$ 阶导数，因此准确度最多是 $n$ 。试图调整选点的策略，让积分表达式达到最优的准确度。
    事实上，如果考虑构建 n 阶的拉格朗日插值多项式，我们得到的表达式为\[\int_a^bf(x)dx=\sum_{i=1}^nc_if(x_i) \] 其中一共有 $2n$ 个变元。于是我们预期这个表达式最多能达到 $2n-1$ 的准确度。<br/><br/>

* 解线性方程组法：如果想让表达式对所有的小于 $2n-1$ 阶的多项式都能准确求值，只需要令 $f(x)=1,\;\;f(x)=x,\;\;f(x)=x^2,\ldots,f(x)=x^{2n-1} $ 分别带入等式，得到 2n 个方程，求出 2n 个变元即可。<br/><br/>

* Legendre 多项式法：当 $x_i,\;\;i=1,2,\cdots,n$ 取 $n$ 阶legendre多项式的根，系数取\[c_i=\int_{-1}^{1}\prod_{j=1,\;j\ne i}^n\frac{x-x_j}{x_i-x_j}dx \] 时，积分表达式 \[\int_{-1}^1f(x)dx=\sum_{i=1}^nc_if(x_i) \] 在 $[-1,1]$ 上具有 $2n-1$ 阶的准确度。当积分区间不是 $[-1,1]$ 时，只需要作线性平移即可。
